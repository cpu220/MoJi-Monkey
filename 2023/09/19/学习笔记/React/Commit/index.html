<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="description" content=""/><meta name="keyword"/><title>MoJo Monkey
-

</title><link rel="icon" href="/img/favicon.ico"/>
<link rel="stylesheet" href="/MoJi-Monkey/css/style.css">

<link rel="stylesheet" href="/MoJi-Monkey/css/helpers.css">
<script async="async" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading-wrapper" data-loading="true"><div class="loading"><span></span><span></span><span></span></div></div><div class="page" data-filter="true"><div class="head" data-show="true"><header class="head-header"><div class="head-author"><a class="head-author-link" href="/MoJi-Monkey/">MoJo Monkey</a></div><div class="head-right"><button class="bar-wrap" id="bar-wrap-toggle"><span class="bar"></span><span class="bar"></span><span class="bar"></span></button><div class="head-item"><a class="search-button head-item-link"><i class="icon icon-search"></i></a></div><div class="head-item"><a class="head-item-link" href="/MoJi-Monkey/about">About</a></div></div></header>
<div class="menu-bar-head" id="menu-bar" data-show="false"><ul class="menu-bar-ul"><li class="menu-bar-item"><a href="/MoJi-Monkey/categories/Posts/"><span>Posts1</span></a></li><li class="menu-bar-item"><a href="/MoJi-Monkey/categories/Posts2/"><span>Posts2</span></a></li><li class="menu-bar-item  border"><a href="/MoJi-Monkey/archives"><span>Archives</span></a></li><li class="menu-bar-item"><a href="/MoJi-Monkey/tags"><span>Tags</span></a></li><li class="menu-bar-item"><a class="search-button"><span>Search</span></a></li><li class="menu-bar-item"><a href="/MoJi-Monkey/about"><span>About</span></a></li></ul></div></div><div class="main"><article class="post" id="post"><header class="post-head"><h1 class="post-title"><a class="title" href="/MoJi-Monkey/2023/09/19/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/React/Commit/">commit 工作流程</a></h1></header><div class="post-datetag"><div class="post-date"><time class="post-time" itemprop="datePublished" title="2023-09-19 19:04:53" datetime="2023-09-19T11:04:53.000Z">2023-09-19</time></div>|<div class="post-tag"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/MoJi-Monkey/tags/react/" rel="tag">react</a></li></ul></div>|
<div class="post-visit"><span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span>hits</span></div></div><div class="post-word-count">本文共3,411字。</div><div class="article-entry" itemprop="articleBody"><h1 id="commit-工作流程"><a href="#commit-工作流程" class="headerlink" title="commit 工作流程"></a>commit 工作流程</h1><blockquote>
<p>以下代码 是 V18.0.0的版本，到了18.1.0后，有较大的改变</p>
</blockquote>
<h2 id="React的工作流程"><a href="#React的工作流程" class="headerlink" title="React的工作流程"></a>React的工作流程</h2><ul>
<li>Render阶段<ul>
<li>Scheduler</li>
<li>Reconciler</li>
</ul>
</li>
<li>Commit阶段<ul>
<li>BeforeMutation (变动前)<ul>
<li>commitBeforeMutaionEffects</li>
<li>commitBeforeMutationEffects_begin</li>
<li>commitBeforeMutationEffects_complete</li>
</ul>
</li>
<li>Mutation （变动）<ul>
<li>commitMutationEffects</li>
<li>commitMutationEffects_begin</li>
<li>commitMutationEffects_complete</li>
</ul>
</li>
<li>FiberTree 交换 （双缓冲）</li>
<li>Layout<ul>
<li>commitLayoutEffects</li>
<li>commitLayoutEffects_begin</li>
<li>commitLayoutEffects_complete</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>需要注意：Render 阶段是在内存中运行，这意味着可能被打断，也可以被打断。而commit阶段一旦开始，就会同步执行，直到完成。<br>Mutation : （动物或植物的）突变，变异；（基因结构突变产生的）突变体，突变型；（形式的）转变，改变；语流音变，变音</p>
</blockquote>
<h3 id="commitXXXEffects"><a href="#commitXXXEffects" class="headerlink" title="commitXXXEffects"></a>commitXXXEffects</h3><p>这个函数，是每个子阶段的入口函数， finishedWork 会作为firstChild 参数传入进去</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitXXXEffects</span>(<span class="params">Root，firstChild</span>)&#123;</span><br><span class="line">    <span class="comment">// 省略标记全局变量</span></span><br><span class="line">    nextEffect = firstChild;</span><br><span class="line">    <span class="comment">// 省略重置全局变量</span></span><br><span class="line">    <span class="title function_">commitXXXEffects_begin</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="commitXXXEffects-begin"><a href="#commitXXXEffects-begin" class="headerlink" title="commitXXXEffects_begin"></a>commitXXXEffects_begin</h3><p>向下遍历FiberNode，遍历的时候会遍历知道第一个满足如下条件之一的 FiberNode</p>
<ol>
<li>当前的FiberNode的子FiberNode不包含该子阶段对应的flags</li>
<li>当前的FiberNode不存在子FiberNode</li>
<li>对目标FiberNode 执行 commitXXXEffects_complete方法，</li>
</ol>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitXXXEffects_begin</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">while</span>(nextEffect !== <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">let</span> fiber = nextEffect;</span><br><span class="line">        <span class="keyword">let</span> chile = fiber.<span class="property">child</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(fiber.<span class="property">subtreeFlags</span> !== <span class="title class_">NoFlags</span> &amp;&amp; child !== <span class="literal">null</span>)&#123;</span><br><span class="line">            nextEffect = child</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_">commitXXXEffects_complete</span>()</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="commitXXXEffects-complete"><a href="#commitXXXEffects-complete" class="headerlink" title="commitXXXEffects_complete"></a>commitXXXEffects_complete</h3><p>该方法主要就是针对flags做具体的操作了，主要包含以下三个步骤</p>
<ol>
<li>对当前FiberNode执行flags对应的操作，也就是执行 commitXXXOnFiber</li>
<li>如果当前FiberNode存在兄弟节点，则对兄弟FiberNode执行 commitXXXEffects_begin</li>
<li>如果当前FiberNode不存在兄弟节点，则对父FiberNode执行 commitXXXEffects_complete</li>
</ol>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitXXXEffects_complete</span>(<span class="params">root</span>)&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(nextEffect !== <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">let</span> fiber = nextEffect;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="title function_">commitXXXEffectsOnFiber</span>(fiber,root);</span><br><span class="line">        &#125;<span class="keyword">catch</span>()&#123; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> sibling = fiber.<span class="property">sibling</span>;</span><br><span class="line">        <span class="keyword">if</span>(sibling !== <span class="literal">null</span>)&#123;</span><br><span class="line">            nextEffect = sibling;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将父节点作为下一个effect</span></span><br><span class="line">        nextEffect = fiber.<span class="property">return</span>;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>nextEffect 是 React 源码中的一个全局变量，它的作用是在 commit 阶段遍历 effectList 链表，执行对应的副作用函数1。effectList 链表是在 render 阶段收集的，它包含了所有有更新的 fiber 节点，每个节点都有一个 effectTag 属性，表示它的更新类型2。</p>
</blockquote>
<blockquote>
<p>每个子阶段都会以DFS （深度遍历）的原则进行遍历，最终会在commitXXXEffectsOnFiber中针对不同的flags做出不同的处理</p>
</blockquote>
<h3 id="BeforeMutation阶段"><a href="#BeforeMutation阶段" class="headerlink" title="BeforeMutation阶段"></a>BeforeMutation阶段</h3><p>BeforeMutation阶段的主要工作发生在 <strong>commitBeforeMutationEffects_complete</strong>  中的  commitBeforeMutationEffectsOnFiber 方法</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 该函数是遍历effectList链表，执行一些副作用函数，比如 getSnapsshotBeforeUpdate</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> finishedWork 在render阶段完成的FiberTree的根节点，是在 performConcurrentWorkOnRoot 函数中被赋值 </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitBeforeMutationEffectsOnFiber</span>(<span class="params">finishedWork</span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> current = finishedWork.<span class="property">alternate</span>;</span><br><span class="line">  <span class="keyword">const</span> flags = finishedWork.<span class="property">falgs</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="comment">// Snapshot 表示 ClassComponent 存在更新，且定义了 getSnapsshotBeforeUpdate 方法</span></span><br><span class="line">  <span class="keyword">if</span>(flags &amp; <span class="title class_">Snapshot</span> !== <span class="title class_">NoFlags</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span>(finishedWork.<span class="property">tag</span>)&#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">ClassComponent</span>: &#123;</span><br><span class="line">        <span class="comment">// 当前指针不为空</span></span><br><span class="line">        <span class="keyword">if</span>(current !== <span class="literal">null</span>)&#123;</span><br><span class="line">          <span class="keyword">const</span> prevProps = current.<span class="property">memoizedProps</span>;</span><br><span class="line">          <span class="keyword">const</span> prevState = current.<span class="property">memoizedState</span>;</span><br><span class="line">          <span class="keyword">const</span> instance = finishedWork.<span class="property">stateNode</span>;</span><br><span class="line">          </span><br><span class="line">          <span class="comment">// 执行 getSnapsshotBeforeUpdate</span></span><br><span class="line">          <span class="keyword">const</span> snapshot = instance.<span class="title function_">getSnapsshotBeforeUpdate</span>(</span><br><span class="line">          	finishedWork.<span class="property">elementType</span> === finishedWork.<span class="property">type</span> ? </span><br><span class="line">            prevProps : <span class="title function_">resolveDefaultProps</span>(finishedWork.<span class="property">type</span>, prevProps),</span><br><span class="line">            prevState</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">HostRoot</span>: &#123;</span><br><span class="line">        <span class="comment">// 清空 HostRoot 挂载的内容，方便 Mutation 阶段渲染</span></span><br><span class="line">        <span class="keyword">if</span>(supportsMutation)&#123;</span><br><span class="line">          <span class="keyword">const</span> root = finishedWork.<span class="property">stateNode</span>;</span><br><span class="line">          <span class="title function_">clearCOntainer</span>(root.<span class="property">containerInfo</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上面的代码，主要是处理两种类型的FiberNode</p>
<ol>
<li>ClassComponent：执行 getSnapsshotBeforeUpdate 方法</li>
<li>HostRoot：执行 clearCOntainer 方法，清空HostRoot挂载的内容，方便Mutation阶段渲染</li>
</ol>
<h2 id="Mutation-阶段"><a href="#Mutation-阶段" class="headerlink" title="Mutation 阶段"></a>Mutation 阶段</h2><p>对于HostComponent、Mutation阶段的主要工作，就是对DOM 进行 增删改操作</p>
<p>入口函数是 commitMutationEffects， 但实际上，真正的工作是在 commitMutationEffectsOnFiber 中完成的</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">commitMutationEffects</span>(<span class="params"></span></span><br><span class="line"><span class="params">  root: FiberRoot,</span></span><br><span class="line"><span class="params">  finishedWork: Fiber,</span></span><br><span class="line"><span class="params">  committedLanes: Lanes,</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  inProgressLanes = committedLanes;</span><br><span class="line">  inProgressRoot = root;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setCurrentDebugFiberInDEV</span>(finishedWork);</span><br><span class="line">  <span class="comment">// 这个才是真正的工作函数</span></span><br><span class="line">  <span class="title function_">commitMutationEffectsOnFiber</span>(finishedWork, root, committedLanes);</span><br><span class="line">  <span class="title function_">setCurrentDebugFiberInDEV</span>(finishedWork);</span><br><span class="line"></span><br><span class="line">  inProgressLanes = <span class="literal">null</span>;</span><br><span class="line">  inProgressRoot = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="删除DOM元素"><a href="#删除DOM元素" class="headerlink" title="删除DOM元素"></a>删除DOM元素</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitMutationEffects_begin</span>(<span class="params">root</span>)&#123;</span><br><span class="line">  <span class="keyword">while</span>(nextEffect !== <span class="literal">null</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect;</span><br><span class="line">    <span class="comment">// 删除 DOM 元素</span></span><br><span class="line">    <span class="keyword">const</span> deletions = fiber.<span class="property">deletions</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(deletions !== <span class="literal">null</span>)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;deletions.<span class="property">length</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">const</span> childToDelete = deletions[i];</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">          <span class="title function_">commitDeletion</span>(root, childToDelete, fiber);</span><br><span class="line">        &#125; <span class="keyword">catch</span>(error)&#123;</span><br><span class="line">          <span class="comment">// 省略错误处理</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> child = fiber.<span class="property">child</span>;</span><br><span class="line">    <span class="keyword">if</span>((fiber.<span class="property">subtreeFlags</span> &amp; <span class="title class_">MutationMask</span>) !== <span class="title class_">NoFlags</span> &amp;&amp; child !== <span class="literal">null</span>)&#123;</span><br><span class="line">      nextEffect = child;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">commitMutationEffects_complete</span>(root);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>删除DOM元素的操作，是发生在 <strong>commitBeforeMutationEffects_begin</strong> 方法中，首先会先拿到 deletions 数组，之后再遍历该数组，进行删除操作。</p>
<blockquote>
<p>需要注意的是，删除一个元素，不仅仅是删除节点，还要将节点上注册的事件也要注销掉等，防止内存溢出</p>
</blockquote>
<ol>
<li>子树中所有组件的 unMount 操作</li>
<li>子树中所有ref 属性的卸载操作</li>
<li>子树中所有Effect 相关 Hook 的 destory 回调的执行</li>
</ol>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;div&gt;</span><br><span class="line">	<span class="language-xml"><span class="tag">&lt;<span class="name">SomeClassComponent</span>/&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">&#123;divRef&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  	<span class="tag">&lt;<span class="name">SomeFunctionComponent</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>当删除最外层div时</p>
<ol>
<li>执行 SomeClassComponent 类组件对应的 ComponentWillUnmount 生命周期函数</li>
<li>执行 SomeFunctionComponent 函数组件中的 useEffect、 useLayoutEffect 的 destory 回调</li>
<li>devRef 的卸载操作</li>
</ol>
<blockquote>
<p>整个删除操作，是以DFS（深度遍历）的顺序，遍历子树的每个FiberNode，执行对应的操作</p>
</blockquote>
<h3 id="插入、移动DOM元素"><a href="#插入、移动DOM元素" class="headerlink" title="插入、移动DOM元素"></a>插入、移动DOM元素</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitMutationEffectsOnFiber</span>(<span class="params">finishedWork, root</span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> flags = finishedWork.<span class="property">flags</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> primaryFlags = flags &amp; (<span class="title class_">Placement</span> | <span class="title class_">Update</span> | <span class="title class_">Hydrating</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="attr">outer</span>: <span class="keyword">switch</span>(primaryFlags)&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">Placement</span>:&#123;</span><br><span class="line">      <span class="comment">// 执行 Placement 对应操作</span></span><br><span class="line">      <span class="title function_">commitPlacement</span>(finishedWork);</span><br><span class="line">      <span class="comment">// 执行完 Placement 对应操作后，移除 Placement flag</span></span><br><span class="line">      finishedWork.<span class="property">falgs</span> &amp;= ~<span class="title class_">Placement</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">PlacementAndUpdate</span>:&#123;</span><br><span class="line">      <span class="comment">// 执行 Placement 对应操作</span></span><br><span class="line">      <span class="title function_">commitPlacement</span>(finishedWork);</span><br><span class="line">      <span class="comment">// 执行完 Placement 对应操作后，移除 Placement flag</span></span><br><span class="line">      finishedWork.<span class="property">falgs</span> &amp;= ~<span class="title class_">Placement</span>;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 执行 Update 对应操作</span></span><br><span class="line">      <span class="keyword">const</span> current = finishedWork.<span class="property">alternate</span>;</span><br><span class="line">      <span class="title function_">commitWork</span>(current, finishedWork);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">      </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以看出， Placement flag 对应的操作方法为 commitPlacement，代码如下：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitPlacement</span>(<span class="params">finishedWork</span>)&#123;</span><br><span class="line">  <span class="comment">// 获取 Host 类型的祖先 FiberNode</span></span><br><span class="line">  <span class="keyword">const</span> parentFiber = <span class="title function_">getHostParentFiber</span>(finishedWork);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 省略根据 parentFiber 获取对应 DOM 元素的逻辑</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">let</span> parent;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 目标 DOM 元素会插入至 before 左边</span></span><br><span class="line">  <span class="keyword">const</span> before = <span class="title function_">getHostSibling</span>(finishedWork);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 省略分支逻辑</span></span><br><span class="line">  <span class="comment">// 执行插入或移动操作</span></span><br><span class="line">  <span class="title function_">insertOrAppendPlacementNode</span>(finishedWork, before, parent);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>整个 commitPlaceMent 方法，可以分为三个步骤</p>
<ol>
<li><p>从当前FiberNode向上遍历，获取第一个类型为 HostComponent、HostRoot、HostPortal 三者之一的组件FiberNode，其对应的DOM元素是执行DOM操作的目标元素的父级DOM元素</p>
</li>
<li><p>获取用于执行 ParentNode.insertBefore(child,before) <strong>方法的 before 对应的DOM元素</strong></p>
</li>
<li><p>执行parentNode.insertBefore方法(存在before)或者parentNode.appendChild方法(不存在before)</p>
</li>
</ol>
<p>对于 <strong>还没有插入的DOM元素</strong> （对应的就是mount场景），insertBefor 会将目标DOM元素插入到before之前，appendChild 会将目标DOM元素作为父DOM元素的最后一个子元素插入</p>
<p>对于UI中已经存在的DOM元素 （对应update场景），insertBefore会将目标DOM元素移动到before之前，appendChild会将目标DOM元素移动到同级最后。</p>
<p>因此，这也是为什么在React中，插入和移动所对应的 flag 都是 placement flag 的原因，</p>
<h3 id="更新DOM元素"><a href="#更新DOM元素" class="headerlink" title="更新DOM元素"></a>更新DOM元素</h3><p>更新DOM元素，主要就是更新对应的属性，执行的方法为commitWork，代码如下：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitWork</span>(<span class="params">current, finishedWork</span>)&#123;</span><br><span class="line">  <span class="keyword">switch</span>(finishedWork.<span class="property">tag</span>)&#123;</span><br><span class="line">    <span class="comment">// 省略其他类型处理逻辑</span></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">HostComponent</span>:&#123;</span><br><span class="line">      <span class="keyword">const</span> instance = finishedWork.<span class="property">stateNode</span>;</span><br><span class="line">      <span class="keyword">if</span>(instance != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> newProps = finishedWork.<span class="property">memoizedProps</span>;</span><br><span class="line">        <span class="keyword">const</span> oldProps = current !== <span class="literal">null</span> ? current.<span class="property">memoizedProps</span> : newProps;</span><br><span class="line">        <span class="keyword">const</span> type = finishedWork.<span class="property">type</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 变化的属性都存在updateQueue</span></span><br><span class="line">        <span class="keyword">const</span> updatePayload = finishedWork.<span class="property">updateQueue</span>;</span><br><span class="line">        finishedWork.<span class="property">updateQueue</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(updatePayload !== <span class="literal">null</span>)&#123;</span><br><span class="line">          <span class="comment">// 存在变化的属性</span></span><br><span class="line">          <span class="title function_">commitUpdate</span>(instance, updatePayload, type, oldProps, newProps, finishedWork);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>变化的属性会以key，value相邻的形式保存在 FiberNode.updateQueue,最终在FiberNode.updateQueue里保存的要变化的属性，就会在一个名为 updateDOMProperties 方法遍历，然后进行处理，这里的处理主要是如下的四种数据</p>
<ol>
<li>style属性变化</li>
<li>innerHTML</li>
<li>直接文本节点变化</li>
<li>其他元素属性的变化</li>
</ol>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">updateDOMProperties</span>(<span class="params">domElement, updatePayload, wasCustomComponentTag, isCustomComponentTag</span>)&#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt; updatePayload.<span class="property">length</span>; i+=<span class="number">2</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> propKey = updatePayload[i];</span><br><span class="line">    <span class="keyword">const</span> propValue = updatePayload[i+<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">if</span>(propKey === <span class="variable constant_">STYLE</span>)&#123;</span><br><span class="line">      <span class="comment">// 处理 style</span></span><br><span class="line">      <span class="title function_">setValueForStyle</span>(domElement, propValue);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(propKey === <span class="variable constant_">DANGEROUSLY_SET_INNER_HTML</span>)&#123;</span><br><span class="line">      <span class="comment">// 处理 innerHTML</span></span><br><span class="line">      <span class="title function_">setInnerHTML</span>(domElement, propValue);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(propsKey === <span class="variable constant_">CHILDREN</span>)&#123;</span><br><span class="line">      <span class="comment">// 处理直接的文本节点</span></span><br><span class="line">      <span class="title function_">setTextContent</span>(domElement, propValue);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 处理其他元素</span></span><br><span class="line">      <span class="title function_">setValueForProperty</span>(domElement, propKey, propValue, isCustomComponentTag);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>当 Mutation 阶段的主要工作完成后，在进入Layout阶段之前，会执行如下代码来完成 FiberTree的切换, 也就是双缓冲</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">root.<span class="property">current</span> = finishedWork;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="Layout-阶段"><a href="#Layout-阶段" class="headerlink" title="Layout 阶段"></a>Layout 阶段</h2><p>有关DOM元素的操作，在 Mutation 阶段完成<br>在这一阶段，主要的工作集中在  commitLayoutEffectsOnFiber 函数中，该函数会遍历 effectList 链表，对于不同的FiberNode，执行不同的操作。执行一些副作用函数，比如 useEffect、useLayoutEffect 的回调函数。</p>
<ul>
<li>对应 classComponent ： 该阶段会指向 componentDidMount、componentDidUpdate方法</li>
<li>对于 FunctionComponent： 该阶段会指向 useEffect、useLayoutEffect 的回调函数</li>
</ul>
<hr>
<h1 id="v18-2-0"><a href="#v18-2-0" class="headerlink" title="v18.2.0"></a>v18.2.0</h1><p>对于之前的 BeforeMutation 和 Mutation阶段，有写变动</p>
<h2 id="BeforeMutation-的改动"><a href="#BeforeMutation-的改动" class="headerlink" title="BeforeMutation 的改动"></a>BeforeMutation 的改动</h2><p>不同于之前，对于deletions的操作是放在  <strong>commitMutationEffects_begin</strong> 里，新版函数改成了 <strong>commitPassiveUnmountEffects_begin</strong> </p>
<p>并且以 <strong>commitPassiveUnmountEffects</strong> 暴露给ReactFiberWorkLoop 调用</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">commitPassiveUnmountEffects</span>(<span class="params">firstChild: Fiber</span>): <span class="keyword">void</span> &#123;</span><br><span class="line">  nextEffect = firstChild;</span><br><span class="line">  <span class="title function_">commitPassiveUnmountEffects_begin</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitPassiveUnmountEffects_begin</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect;</span><br><span class="line">    <span class="keyword">const</span> child = fiber.<span class="property">child</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((nextEffect.<span class="property">flags</span> &amp; <span class="title class_">ChildDeletion</span>) !== <span class="title class_">NoFlags</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> deletions = fiber.<span class="property">deletions</span>;</span><br><span class="line">      <span class="keyword">if</span> (deletions !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; deletions.<span class="property">length</span>; i++) &#123;</span><br><span class="line">          <span class="keyword">const</span> fiberToDelete = deletions[i];</span><br><span class="line">          nextEffect = fiberToDelete;</span><br><span class="line">          <span class="title function_">commitPassiveUnmountEffectsInsideOfDeletedTree_begin</span>(</span><br><span class="line">            fiberToDelete,</span><br><span class="line">            fiber,</span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (deletedTreeCleanUpLevel &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">         </span><br><span class="line">          <span class="keyword">const</span> previousFiber = fiber.<span class="property">alternate</span>;</span><br><span class="line">          <span class="keyword">if</span> (previousFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> detachedChild = previousFiber.<span class="property">child</span>;</span><br><span class="line">            <span class="keyword">if</span> (detachedChild !== <span class="literal">null</span>) &#123;</span><br><span class="line">              previousFiber.<span class="property">child</span> = <span class="literal">null</span>;</span><br><span class="line">              <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> detachedSibling = detachedChild.<span class="property">sibling</span>;</span><br><span class="line">                detachedChild.<span class="property">sibling</span> = <span class="literal">null</span>;</span><br><span class="line">                detachedChild = detachedSibling;</span><br><span class="line">              &#125; <span class="keyword">while</span> (detachedChild !== <span class="literal">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        nextEffect = fiber;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((fiber.<span class="property">subtreeFlags</span> &amp; <span class="title class_">PassiveMask</span>) !== <span class="title class_">NoFlags</span> &amp;&amp; child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      child.<span class="property">return</span> = fiber;</span><br><span class="line">      nextEffect = child;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">commitPassiveUnmountEffects_complete</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>这么改动，官方的说法是为了优化 <strong>commit</strong> 阶段的性能。<br>因为原来的方式，会导致commit阶段的时间过长，所以在新版里，deletions是在workLoop里，和其他effects一起处理。这样有利于Scheduler的调度机制</p>
<h2 id="Mutation-的改动"><a href="#Mutation-的改动" class="headerlink" title="Mutation 的改动"></a>Mutation 的改动</h2><p>主要是对于副作用的处理进行了调整。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitMutationEffectsOnFiber</span>(<span class="params"></span></span><br><span class="line"><span class="params">  finishedWork: Fiber,<span class="comment">// 当前Fiber节点</span></span></span><br><span class="line"><span class="params">  root: FiberRoot, <span class="comment">// FiberRoot对象</span></span></span><br><span class="line"><span class="params">  lanes: Lanes, <span class="comment">// 已完成的lanes</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> current = finishedWork.<span class="property">alternate</span>;</span><br><span class="line">  <span class="keyword">const</span> flags = finishedWork.<span class="property">flags</span>;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">switch</span> (finishedWork.<span class="property">tag</span>) &#123;</span><br><span class="line">    <span class="comment">// 函数式组件</span></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">FunctionComponent</span>:</span><br><span class="line">      <span class="comment">// 转发ref的组件</span></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">ForwardRef</span>:</span><br><span class="line">      <span class="comment">// React.forwardRef((props,ref)=&gt;&#123;&#125;),在commit阶段会执行组件的渲染函数，并更新stateNode为返回的React元素</span></span><br><span class="line">      <span class="comment">// React.memo包裹的组件，用来优化性能，避免不必要的重渲染</span></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">MemoComponent</span>:</span><br><span class="line">      <span class="comment">// React.memo包裹的组件，并且只有一个子节点，在commit阶段会执行组件的渲染函数，并更新stateNode为返回的React元素</span></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">SimpleMemoComponent</span>: &#123;</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 类组件</span></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">ClassComponent</span>: &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 递归遍历并处理Fiber节点树上的mutation effects（变更效果）。这些效果可能包括组件的更新、删除或插入等。</span></span><br><span class="line">      <span class="title function_">recursivelyTraverseMutationEffects</span>(root, finishedWork, lanes);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 提交reconciliation effects（协调效果）。这些效果是在React的协调阶段产生的，包括组件的更新、删除或插入等。</span></span><br><span class="line">      <span class="title function_">commitReconciliationEffects</span>(finishedWork);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 检查finishedWork的flags是否包含Ref标志。如果包含，说明这个Fiber节点有关联的ref。</span></span><br><span class="line">      <span class="keyword">if</span> (flags &amp; <span class="title class_">Ref</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果current（即当前的Fiber节点）不为null，说明这个Fiber节点在上一次渲染中是存在的。</span></span><br><span class="line">        <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">// 安全地解除current与其关联的ref的关系。这通常在组件卸载或ref改变时发生。</span></span><br><span class="line">          <span class="title function_">safelyDetachRef</span>(current, current.<span class="property">return</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 检查finishedWork的flags是否包含Callback标志，并且offscreenSubtreeIsHidden为true。如果满足，说明这个Fiber节点有关联的回调函数，且其子树是隐藏的。</span></span><br><span class="line">      <span class="keyword">if</span> (flags &amp; <span class="title class_">Callback</span> &amp;&amp; offscreenSubtreeIsHidden) &#123;</span><br><span class="line">        <span class="comment">// 获取finishedWork的updateQueue，这个队列中存放了这个Fiber节点的所有待处理的更新。</span></span><br><span class="line">        <span class="keyword">const</span> <span class="attr">updateQueue</span>: <span class="title class_">UpdateQueue</span>&lt;mixed&gt; | <span class="literal">null</span> =</span><br><span class="line">          (finishedWork.<span class="property">updateQueue</span>: any);</span><br><span class="line">        <span class="comment">// 如果updateQueue不为null，说明有待处理的更新。</span></span><br><span class="line">        <span class="keyword">if</span> (updateQueue !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">// 延迟处理隐藏的回调函数。这通常在组件被隐藏时发生，以优化性能。</span></span><br><span class="line">          <span class="title function_">deferHiddenCallbacks</span>(updateQueue);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 可以提升到父节点的宿主组件，如注释节点，在commit阶段会创建或更新对应的DOM节点，并添加到父节点中</span></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">HostHoistable</span>: &#123;</span><br><span class="line">       </span><br><span class="line">      <span class="comment">// Fall through</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 表示不能提升到父节点的宿主组件，如文本节点，在commit阶段会创建更新对应节点，并添加到父节点中。</span></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">HostSingleton</span>: &#123;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// Fall through</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 表示普通的宿主组件，如div、span等，在commit阶段会创建或更新对应的DOM节点，并添加到父节点中</span></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">HostComponent</span>: &#123;</span><br><span class="line">       </span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 表示文本内容</span></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">HostText</span>: &#123;</span><br><span class="line">       </span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 根节点</span></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">HostRoot</span>: &#123;</span><br><span class="line">       </span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 传送门组件，创建脱离文本流的组件，</span></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">HostPortal</span>: &#123;</span><br><span class="line">       </span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// suspense组件，用来实现一步加载和延迟渲染，在commit阶段会根据当前的状态，选择显示fallback或children，并执行相关逻辑</span></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">SuspenseComponent</span>: &#123;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Offscreen组件，用来实现隐藏或延迟渲染，在commit阶段会根据当前章台选择显示货隐藏子节点</span></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">OffscreenComponent</span>: &#123;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 表示SuspenseList组件，用来控制多个Suspense组件之间的加载顺序</span></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">SuspenseListComponent</span>: &#123;</span><br><span class="line">       </span><br><span class="line">     </span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 表示Scope组件，用来实现时间委托和事件冒泡，在commit阶段不做任何操作</span></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">ScopeComponent</span>: &#123;</span><br><span class="line">       </span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attr">default</span>: &#123;</span><br><span class="line">      <span class="title function_">recursivelyTraverseMutationEffects</span>(root, finishedWork, lanes);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  这个方法，就是用来注销effect的</span></span><br><span class="line">      <span class="title function_">commitReconciliationEffects</span>(finishedWork);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="commitReconciliationEffects"><a href="#commitReconciliationEffects" class="headerlink" title="commitReconciliationEffects"></a>commitReconciliationEffects</h3><p>这里的内容，就和之前版本的 commitMutationEffectsOnFiber 内容有关。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitReconciliationEffects</span>(<span class="params">finishedWork: Fiber</span>) &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> flags = finishedWork.<span class="property">flags</span>;</span><br><span class="line">  <span class="keyword">if</span> (flags &amp; <span class="title class_">Placement</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 核心就这么一个方法执行</span></span><br><span class="line">      <span class="title function_">commitPlacement</span>(finishedWork);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="title function_">captureCommitPhaseError</span>(finishedWork, finishedWork.<span class="property">return</span>, error);</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    finishedWork.<span class="property">flags</span> &amp;= ~<span class="title class_">Placement</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (flags &amp; <span class="title class_">Hydrating</span>) &#123;</span><br><span class="line">    finishedWork.<span class="property">flags</span> &amp;= ~<span class="title class_">Hydrating</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="commitPlacement"><a href="#commitPlacement" class="headerlink" title="commitPlacement"></a>commitPlacement</h3><p>这个方法，是用来插入新的DOM节点的，根据 flashedWork的effectTag，来判断是否需要插入新的节点。<br>如果是，就先清空</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitPlacement</span>(<span class="params">finishedWork: Fiber</span>): <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!supportsMutation) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125; </span><br><span class="line">   <span class="comment">// 获取 Host 类型的祖先 FiberNode</span></span><br><span class="line">  <span class="keyword">const</span> parentFiber = <span class="title function_">getHostParentFiber</span>(finishedWork);</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">switch</span> (parentFiber.<span class="property">tag</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">HostComponent</span>: &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="attr">parent</span>: <span class="title class_">Instance</span> = parentFiber.<span class="property">stateNode</span>;</span><br><span class="line">      <span class="keyword">if</span> (parentFiber.<span class="property">flags</span> &amp; <span class="title class_">ContentReset</span>) &#123; </span><br><span class="line">        <span class="title function_">resetTextContent</span>(parent);</span><br><span class="line">       </span><br><span class="line">        parentFiber.<span class="property">flags</span> &amp;= ~<span class="title class_">ContentReset</span>;</span><br><span class="line">      &#125;</span><br><span class="line"> <span class="comment">// 目标 DOM 元素会插入至 before 左边</span></span><br><span class="line">      <span class="keyword">const</span> before = <span class="title function_">getHostSibling</span>(finishedWork);</span><br><span class="line">     <span class="comment">// 执行插入或移动操作</span></span><br><span class="line">      <span class="title function_">insertOrAppendPlacementNode</span>(finishedWork, before, parent);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">HostRoot</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">HostPortal</span>: &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="attr">parent</span>: <span class="title class_">Container</span> = parentFiber.<span class="property">stateNode</span>.<span class="property">containerInfo</span>;</span><br><span class="line">      <span class="keyword">const</span> before = <span class="title function_">getHostSibling</span>(finishedWork);</span><br><span class="line">      <span class="title function_">insertOrAppendPlacementNodeIntoContainer</span>(finishedWork, before, parent);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// eslint-disable-next-line-no-fallthrough</span></span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">        <span class="string">&#x27;Invalid host parent fiber. This error is likely caused by a bug &#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;in React. Please file an issue.&#x27;</span>,</span><br><span class="line">      );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>commit 主要是3个阶段</p>
<ul>
<li>BeforeMutation 阶段，主要是处理ClassComponent、HostRoot 两种类型的FiberNode</li>
<li>Mutation 阶段，主要是处理DOM的增删改</li>
<li>Layout 阶段，会根据不同的FiberNode的类型不同，执行对应的副作用函数</li>
</ul>
</div></article><aside class="post-widget"><nav class="post-toc-wrap" id="post-toc"><h4>TOC</h4><ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#commit-%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="post-toc-number">1.</span> <span class="post-toc-text">commit 工作流程</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#React%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">React的工作流程</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#commitXXXEffects"><span class="post-toc-number">1.1.1.</span> <span class="post-toc-text">commitXXXEffects</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#commitXXXEffects-begin"><span class="post-toc-number">1.1.2.</span> <span class="post-toc-text">commitXXXEffects_begin</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#commitXXXEffects-complete"><span class="post-toc-number">1.1.3.</span> <span class="post-toc-text">commitXXXEffects_complete</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#BeforeMutation%E9%98%B6%E6%AE%B5"><span class="post-toc-number">1.1.4.</span> <span class="post-toc-text">BeforeMutation阶段</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Mutation-%E9%98%B6%E6%AE%B5"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">Mutation 阶段</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%88%A0%E9%99%A4DOM%E5%85%83%E7%B4%A0"><span class="post-toc-number">1.2.1.</span> <span class="post-toc-text">删除DOM元素</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%8F%92%E5%85%A5%E3%80%81%E7%A7%BB%E5%8A%A8DOM%E5%85%83%E7%B4%A0"><span class="post-toc-number">1.2.2.</span> <span class="post-toc-text">插入、移动DOM元素</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%9B%B4%E6%96%B0DOM%E5%85%83%E7%B4%A0"><span class="post-toc-number">1.2.3.</span> <span class="post-toc-text">更新DOM元素</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Layout-%E9%98%B6%E6%AE%B5"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">Layout 阶段</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#v18-2-0"><span class="post-toc-number">2.</span> <span class="post-toc-text">v18.2.0</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#BeforeMutation-%E7%9A%84%E6%94%B9%E5%8A%A8"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">BeforeMutation 的改动</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Mutation-%E7%9A%84%E6%94%B9%E5%8A%A8"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">Mutation 的改动</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#commitReconciliationEffects"><span class="post-toc-number">2.2.1.</span> <span class="post-toc-text">commitReconciliationEffects</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#commitPlacement"><span class="post-toc-number">2.2.2.</span> <span class="post-toc-text">commitPlacement</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E6%80%BB%E7%BB%93"><span class="post-toc-number">3.</span> <span class="post-toc-text">总结</span></a></li></ol></nav></aside></div><footer class="footer-nav"><div class="footer"><div class="back-top" id="back-top" title="Back to top"><i class="icon icon-chevron-bar-up"></i></div><span class="footer-msg"><div><span id="busuanzi_container_site_pv"><span id="busuanzi_value_site_pv">?</span>
PV
</span><span id="busuanzi_container_site_uv"><span id="busuanzi_value_site_uv">?</span>
UV</span></div>

Copyright &copy;
<span class="time-divide">-</span>2023
Belial.

Power by
<a href="https://hexo.io/" target="_blank" rel="external nofollow">Hexo</a>
and
<a href="https://github.com/Cerallin/hexo-theme-yuzu" target="_blank" rel="external nofollow" title="v3.1">Theme Yuzu</a>.</span></div></footer><script>window.config = {
  url_root: '/MoJi-Monkey/',
  meta_path: 'meta.json',
};
</script>
<script src="/MoJi-Monkey/js/clipboard/clipboard.min.js"></script>


<script src="/MoJi-Monkey/js/theme.js"></script>


<script src="/MoJi-Monkey/js/index.js"></script>

<script src="/MoJi-Monkey/js/toc.js"></script>
</div><div class="search-modal" id="search-modal" data-show="false"><div class="card"><div class="card-head"><div class="search-box"><input class="search-input" id="search-input" placeholder="search"/><div class="search-button" id="search-button"><div class="icon icon-search"></div></div></div><div class="close-button"><div class="icon icon-x"></div></div></div><div class="card-body"><div class="search-count">search.total<span id="search-count-num">0</span>search result(s) in total.</div><div class="search-result" id="search-result"></div></div></div></div></body></html>